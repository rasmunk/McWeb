# If we receive X-Forwarded-Proto, pass it through; otherwise, pass along the
# scheme used to connect to this server
map $http_x_forwarded_proto $proxy_x_forwarded_proto {
	default $http_x_forwarded_proto;
	'' $scheme;
}
# If we receive X-Forwarded-Port, pass it through; otherwise, pass along the
# server port the client connected to
map $http_x_forwarded_port $proxy_x_forwarded_port {
	default $http_x_forwarded_port;
	'' $server_port;
}
# If we receive Upgrade, set Connection to "upgrade"; otherwise, delete any
# Connection header that may have been passed to this server
map $http_upgrade $proxy_connection {
	default upgrade;
	'' close;
}

# Set appropriate X-Forwarded-Ssl header
map $scheme $proxy_x_forwarded_ssl {
	default off;
	https on;
}

log_format mcwebhost '$host $remote_addr - $remote_user [$time_local] '
                 '"$request" $status $body_bytes_sent '
                 '"$http_referer" "$http_user_agent"';

access_log off;

# mcweb.test
upstream mcweb.test {
	server mcweb:8080;
}
server {
	server_name mcweb.test;
	listen 8080 default_server;
	access_log /var/log/nginx/mcweb.log mcwebhost;	

	root /srv/mcweb;
	index index.html index.htm index.php;

	charset utf-8;

	client_max_body_size 75M;

	# simulator
	rewrite ^/simulator/(.*)$ /;
	location /static {
		alias      /srv/mcweb/McWeb/mcsimrunner/static;
	}
	location /out {
		alias      /srv/mcweb/McWeb/mcsimrunner/out;
	}
	location / {
		uwsgi_pass unix:/srv/mcweb/McWeb/mcweb.sock;
		include    /etc/nginx/uwsgi_params; #these also exist in /etc/nginx/
	}
	rewrite ^/moodle/(.*\.php)(/)(.*)$ /moodle/$1?file=/$3 last;
	location /moodle {
		alias /srv/mcweb/moodle;
	}

	# Protect mediawiki install image dir againt scripting attacks
	location /mediawiki/images {
		location ~ .*\.(php)?$ { 
			deny all; 
		}
		location ~ .*\.(py)?$ { 

		}
	}

	location /mediawiki {
		alias /srv/mcweb/mediawiki;
	}

	# Protect mediawiki install image dir againt scripting attacks
	location /wiki/images {
		location ~ .*\.(php)?$ { 
			deny all; 
		}
		location ~ .*\.(py)?$ { 
			deny all; 
		}
	}

	location /wiki {
		alias /srv/mcweb/wiki;
	}

	location /piwik {
		alias /srv/mcweb/piwik;
	}

	location /mathjax {
		alias /srv/mcweb/mathjax;
	}

	location /ssp {
		alias /srv/mcweb/ssp;
	}    
    
	location /landing {
		alias /srv/mcweb/landing;
	} 

	location ~ \.php$ {
#		include snippets/fastcgi-php.conf;
#		fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;
	}
}

# www.mcweb.test
#upstream www.mcweb.test {
#	server mcweb:8080;
#}
#server {
#	server_name www.mcweb.test;
#	listen 8080;
#	access_log /var/log/nginx/mcweb.log mcwebhost;
#	root /srv/mcweb.test;
#}

